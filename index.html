<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TimeTrackingApp Proto</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --bg: #f5f5f5;
      --card: #ffffff;
      --text: #1a1a1a;
      --text-muted: #555555;
      --primary: #0054d1;
      --secondary: #0d1117;
      --success: #18a957;
      --warning: #d15800;
      --border: rgba(0, 0, 0, 0.08);
      --input-bg: #ffffff;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0d1117;
        --card: #161b22;
        --text: #e6edf3;
        --text-muted: #8b949e;
        --primary: #388bfd;
        --success: #3fb950;
        --warning: #d29922;
        --border: rgba(255, 255, 255, 0.1);
        --input-bg: #21262d;
      }
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.6rem;
    }
    .card {
      width: min(480px, 100%);
      background: var(--card);
      border-radius: 24px;
      box-shadow: 0 15px 45px rgba(15, 23, 42, 0.15);
      overflow: hidden;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    .login,
    .chat {
      padding: 1.8rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .login h1,
    .chat h1 {
      margin: 0;
      font-size: clamp(1.4rem, 4vw, 1.8rem);
    }
    .pin-input {
      display: flex;
      gap: 0.75rem;
      justify-content: space-between;
    }
    .pin-input input {
      width: 100%;
      padding: 0.9rem 1rem;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 1.1rem;
      text-align: center;
      letter-spacing: 0.35rem;
      font-weight: 600;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 16px;
      padding: 0.95rem 1rem;
      font-size: 1rem;
      font-weight: 600;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
      transition: transform 0.2s ease, background 0.2s ease;
    }
    button:active {
      transform: scale(0.98);
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
    }
    .hidden {
      display: none !important;
    }
    .chat-area {
      flex: 1;
      background: var(--input-bg);
      border-radius: 18px;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
      max-height: 60vh;
    }
    .bubble {
      padding: 0.85rem 1rem;
      border-radius: 16px;
      line-height: 1.45;
      font-size: 0.95rem;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .bubble.user {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .bubble.assistant {
      align-self: flex-start;
      background: var(--card);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }
    .json-toggle {
      color: var(--primary);
      font-size: 0.8rem;
      cursor: pointer;
      text-decoration: underline;
      margin-top: 0.5rem;
      display: inline-block;
    }
    .json-toggle:hover {
      opacity: 0.7;
    }
    .json-content {
      display: none;
      background: var(--input-bg);
      border-radius: 8px;
      padding: 0.6rem;
      margin-top: 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
      overflow-x: auto;
      color: var(--text);
    }
    .json-content.visible {
      display: block;
    }
    .composer {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .composer textarea {
      width: 100%;
      resize: none;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      padding: 0.85rem 1rem;
      font-size: 1rem;
      min-height: 120px;
    }
    .composer .buttons {
      display: flex;
      gap: 0.7rem;
    }
    .composer button {
      flex: 1;
      min-width: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .status {
      font-size: 0.85rem;
      color: var(--text-muted);
      min-height: 1.2rem;
    }
    .pill {
      align-self: flex-start;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      color: var(--primary);
      background: rgba(0, 84, 209, 0.12);
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
    }
    @media (max-width: 520px) {
      body {
        padding: 0.8rem;
      }
      .card {
        border-radius: 18px;
      }
    }
  </style>
</head>
<body>
  <main class="card">
    <section class="login" id="loginScreen" aria-live="polite">
      <h1>TimeTrackingApp</h1>
      <p>Kirjaudu henkil√∂kohtaisella PIN-koodillasi.</p>
      <div class="pin-input">
        <input
          type="password"
          inputmode="numeric"
          maxlength="5"
          autocomplete="one-time-code"
          aria-label="PIN-koodi"
          id="pinInput"
        />
      </div>
      <button class="btn-primary" id="pinBtn">Kirjaudu</button>
      <div class="status" id="pinStatus"></div>
    </section>

    <section class="chat hidden" id="chatScreen">
      <div class="pill">Kirjattu sis√§√§n</div>
      <h1>Ty√∂tuntien kirjaus</h1>
      <div class="chat-area" id="chatArea"></div>
      <div class="composer">
        <textarea id="chatInput" placeholder="Kirjoita tai sanele esim. 15.11 klo 8‚Äì12 projekti Alfa."></textarea>
        <div class="buttons">
          <button class="btn-primary" id="sendBtn" title="L√§het√§">‚û§</button>
          <button id="micBtn" title="Sanelu">üéôÔ∏è</button>
        </div>
      </div>
      <div class="status" id="chatStatus">Valmis.</div>
    </section>
  </main>

  <script>
    const PIN_CODE = "12345";
    const APP_KEY = "tT9#kL2$mN7@pQ4!23"; // sama kuin save_hours.php:ssa

    const loginScreen = document.getElementById("loginScreen");
    const chatScreen = document.getElementById("chatScreen");
    const pinInput = document.getElementById("pinInput");
    const pinBtn = document.getElementById("pinBtn");
    const pinStatus = document.getElementById("pinStatus");

    const chatArea = document.getElementById("chatArea");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatStatus = document.getElementById("chatStatus");
    const micBtn = document.getElementById("micBtn");

    let conversationHistory = [
      {
        role: "system",
        content:
          "Olet TimeTrackingApp tuntikirjausassistentti. Keskustele suomeksi. Pyyd√§ k√§ytt√§j√§√§ tarkentamaan tarvittavat tiedot ja muodosta lopuksi JSON, joka sis√§lt√§√§ p√§iv√§m√§√§r√§n, kellonajat, projektin ja tuntim√§√§r√§n. Esimerkki: {\"entries\":[{\"date\":\"2025-11-15\",\"start\":\"08:00\",\"end\":\"12:00\",\"hours\":4,\"project\":\"Projekti Alfa\",\"notes\":\"Asennus\"}]}",
      },
    ];
    let recognition;

    function showError(el, msg) {
      el.textContent = msg;
      el.style.color = "var(--warning)";
    }
    function showSuccess(el, msg) {
      el.textContent = msg;
      el.style.color = "var(--success)";
    }

    function appendBubble(text, role = "assistant") {
      const div = document.createElement("div");
      div.className = `bubble ${role}`;
      
      // Piilota JSON toggle-elementin taakse assistant-viesteiss√§
      if (role === "assistant" && text.includes("```json")) {
        const parts = text.split(/```json[\s\S]*?```/);
        const jsonMatch = text.match(/```json([\s\S]*?)```/);
        
        const textSpan = document.createElement("span");
        textSpan.textContent = parts[0].trim();
        div.appendChild(textSpan);
        
        if (jsonMatch) {
          const toggleLink = document.createElement("span");
          toggleLink.className = "json-toggle";
          toggleLink.textContent = "üìã Avaa JSON";
          
          const jsonContent = document.createElement("pre");
          jsonContent.className = "json-content";
          jsonContent.textContent = jsonMatch[1].trim();
          
          toggleLink.addEventListener("click", () => {
            jsonContent.classList.toggle("visible");
            toggleLink.textContent = jsonContent.classList.contains("visible") 
              ? "üìã Piilota JSON" 
              : "üìã Avaa JSON";
          });
          
          div.appendChild(document.createElement("br"));
          div.appendChild(toggleLink);
          div.appendChild(jsonContent);
        }
      } else {
        div.textContent = text;
      }
      
      chatArea.appendChild(div);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function toggleLoading(isLoading, message = "") {
      chatStatus.textContent = message || (isLoading ? "Ty√∂stet√§√§n..." : "Valmis.");
      sendBtn.disabled = isLoading;
    }

    function parseJSONFromText(text) {
      const match = text.match(/```json([\s\S]*?)```/);
      if (!match) return null;
      try {
        return JSON.parse(match[1]);
      } catch (e) {
        console.warn("JSON-parsaus ep√§onnistui", e);
        return null;
      }
    }

    async function persistEntries(structuredData) {
      try {
        const res = await fetch("save_hours.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-App-Key": APP_KEY,
          },
          body: JSON.stringify(structuredData),
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.message || "Tallennus ep√§onnistui");
        showSuccess(chatStatus, "Tunnit tallennettu.");
      } catch (error) {
        showError(chatStatus, `Tallennusvirhe: ${error.message}`);
      }
    }

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      appendBubble(text, "user");
      conversationHistory.push({ role: "user", content: text });
      chatInput.value = "";
      toggleLoading(true, "Kysyt√§√§n assistentilta...");

      try {
        const res = await fetch("llm_proxy.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ history: conversationHistory.slice(-12) }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "LLM-virhe");
        const reply = data.reply || "En saanut vastausta.";
        appendBubble(reply, "assistant");
        conversationHistory.push({ role: "assistant", content: reply });

        const structured = parseJSONFromText(reply);
        if (structured?.entries?.length) {
          await persistEntries(structured);
        } else {
          showError(chatStatus, "Assistentti ei palauttanut JSON-tietoja. Pyyd√§ tarkennusta.");
        }
      } catch (error) {
        console.error(error);
        showError(chatStatus, `Virhe: ${error.message}`);
      } finally {
        toggleLoading(false);
      }
    }

    function initSpeech() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        micBtn.disabled = true;
        micBtn.title = "Selain ei tue sanelua";
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = "fi-FI";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        chatInput.value = chatInput.value
          ? `${chatInput.value.trim()} ${transcript}`
          : transcript;
      };
      recognition.onerror = () => {
        showError(chatStatus, "Sanelu ep√§onnistui.");
      };
      recognition.onend = () => {
        micBtn.textContent = "üéôÔ∏è";
      };

      micBtn.addEventListener("click", () => {
        if (micBtn.textContent === "‚èπÔ∏è") {
          recognition.stop();
          return;
        }
        recognition.start();
        micBtn.textContent = "‚èπÔ∏è";
        showSuccess(chatStatus, "Kuunnellaan...");
      });
    }

    pinBtn.addEventListener("click", () => {
      if (pinInput.value === PIN_CODE) {
        loginScreen.classList.add("hidden");
        chatScreen.classList.remove("hidden");
        showSuccess(chatStatus, "Kirjaa ty√∂tunteja sanelemalla tai kirjoittamalla.");
        appendBubble(
          "Hei!\n\nKerro milloin teit tunteja ja mille projektille. Muotoilen ne tuntikirjauksiksi ja voit l√§hett√§√§ ne hyv√§ksytt√§viksi.\n\nEsim: 'T√§n√§√§n klo 9‚Äì12, Projekti Alfa'. Voit sy√∂tt√§√§ tunteja my√∂s antamalla p√§iv√§m√§√§ri√§ ja loppuun voi antaa oman kommenttisi.\n\nEsim: '15.11 klo 8‚Äì12 projekti Alfa kommentti: Meni ennakoitua pidemp√§√§n'"
        );
      } else {
        showError(pinStatus, "V√§√§r√§ PIN. Yrit√§ uudelleen.");
        pinInput.focus();
      }
    });

    // Lis√§√§ t√§m√§ - Enter-n√§pp√§in PIN-kent√§ss√§
    pinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        pinBtn.click();
      }
    });

    sendBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.addEventListener("DOMContentLoaded", initSpeech);
  </script>
</body>
</html>